#!/usr/bin/env ruby

require 'syntax/convertors/html'

class LineNumberFilter
  def initialize(every=1, sep='  ')
    @every = every
    @sep = sep
  end
  def filter(text)
    n = 0
    text.split("\n").collect { |ln|
      n += 1
      if (n % @every == 0)
        no = "%3d#{@sep}  " % n
      else
        no = "   #{@sep}  "
      end
      "<span class=\"linenumber\">#{no}</span>#{ln}"
    }.join("\n")
  end
end

class Styler
  def style
    %(<style type="text/css">
.ruby { font-size: 24pt; font-weight: bold; }
.ruby .normal {}
.ruby .linenumber { color: #aaa; font-style: italic; font-size: 16pt; }
.ruby .comment { color: #888; font-style: italic; }
.ruby .keyword { color: #A00; font-weight: bold; }
.ruby .method { color: #077; }
.ruby .class { color: #074; }
.ruby .module { color: #050; }
.ruby .punct { color: #447; font-weight: bold; }
.ruby .symbol { color: #099; }
.ruby .string { color: #944; }
.ruby .char { color: #F07; }
.ruby .ident { color: #004; }
.ruby .constant { color: #07F; }
.ruby .regex { color: #B66; }
.ruby .number { color: #D55; }
.ruby .attribute { color: #377; }
.ruby .global { color: #3B7; }
.ruby .expr { color: #227; }
</style>)
  end
end

class ExtractLiteral
  def initialize(literal_text)
    @literal_text = literal_text
  end
  def extract
    @literal_text
  end
end

class FileExtractor
  def initialize(file_name)
    @file_name = file_name
  end
  def extract
    open(@file_name) { |f| f.read }
  end
end

class Formatter
  def initialize(extractor, styler=Styler.new)
    @extractor = extractor
    @styler = Styler.new
  end
  def convert
    convertor = Syntax::Convertors::HTML.for_syntax("ruby")
    formatted_code = convertor.convert(@extractor.extract)
    formatted_code.gsub(/<\/?pre>/, '')
  end
  def format
    filt = LineNumberFilter.new(5)
    formatted_code = filt.filter(convert)
    "<html><head>#{@styler.style}</head><body><pre class=\"ruby\">#{formatted_code}</pre></body></html>"
  end
end

def extract(outfile, infile)
  file outfile => infile do
    puts "Extracting #{outfile}"
    formatter = Formatter.new(FileExtractor.new(infile))
    open(outfile, "w") do |out|
      out.puts formatter.format
    end
  end
end
